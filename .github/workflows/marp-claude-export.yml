name: Marp Export with Claude Code

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'input/**/*.md'

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  # ã‚¹ãƒ†ãƒƒãƒ—1: Marpè³‡æ–™ã‚’ç”Ÿæˆ
  export-marp:
    runs-on: ubuntu-latest
    outputs:
      files_found: ${{ steps.changed-files.outputs.files_found }}
      changed_files: ${{ steps.changed-files.outputs.changed_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Get changed Markdown files
        id: changed-files
        run: |
          git diff --name-only --diff-filter=AM origin/${{ github.event.pull_request.base.ref }}...HEAD | grep '^input/.*\.md$' > changed_files.txt || true

          if [ -s changed_files.txt ]; then
            echo "files_found=true" >> $GITHUB_OUTPUT
            FILES=$(cat changed_files.txt | tr '\n' ',' | sed 's/,$//')
            echo "changed_files=$FILES" >> $GITHUB_OUTPUT
            echo "âœ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            cat changed_files.txt
          else
            echo "files_found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  input/ä»¥ä¸‹ã«å¤‰æ›´ã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi

      - name: Create output directory
        if: steps.changed-files.outputs.files_found == 'true'
        run: mkdir -p output

      - name: Export to PDF and PPTX
        if: steps.changed-files.outputs.files_found == 'true'
        run: |
          export_summary=""

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ å‡¦ç†ä¸­: $file"
              basename=$(basename "$file" .md)

              # PDFã«å¤‰æ›
              if marp "$file" --theme theme/theme.css --pdf --allow-local-files -o "output/${basename}.pdf"; then
                echo "âœ“ PDFã‚’ç”Ÿæˆ: output/${basename}.pdf"
                export_summary="${export_summary}\nâœ“ ${basename}.pdf"
              else
                echo "âœ— PDFç”Ÿæˆå¤±æ•—: $file"
                export_summary="${export_summary}\nâœ— ${basename}.pdf (å¤±æ•—)"
              fi

              # PPTXã«å¤‰æ›
              if marp "$file" --theme theme/theme.css --pptx --allow-local-files -o "output/${basename}.pptx"; then
                echo "âœ“ PPTXã‚’ç”Ÿæˆ: output/${basename}.pptx"
                export_summary="${export_summary}\nâœ“ ${basename}.pptx"
              else
                echo "âœ— PPTXç”Ÿæˆå¤±æ•—: $file"
                export_summary="${export_summary}\nâœ— ${basename}.pptx (å¤±æ•—)"
              fi

              echo "---"
            fi
          done < changed_files.txt

          echo -e "$export_summary" > export_summary.txt

      - name: Commit generated files
        if: steps.changed-files.outputs.files_found == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add output/*.pdf output/*.pptx 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "âš ï¸  æ–°ã—ã„å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "ğŸ¤– è‡ªå‹•ç”Ÿæˆ: Marpè³‡æ–™ã‚’PDF/PPTXã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ" \
                       -m "Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"
            git push
            echo "âœ“ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: Upload PDF files as artifact
        if: steps.changed-files.outputs.files_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: marp-pdf-files
          path: output/*.pdf
          retention-days: 30

      - name: Upload PPTX files as artifact
        if: steps.changed-files.outputs.files_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: marp-pptx-files
          path: output/*.pptx
          retention-days: 30

      - name: Upload export summary
        if: steps.changed-files.outputs.files_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: export-summary
          path: export_summary.txt
          retention-days: 1

  # ã‚¹ãƒ†ãƒƒãƒ—2: Claude Codeã«ã‚ˆã‚‹å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  claude-quality-check:
    needs: export-marp
    if: needs.export-marp.outputs.files_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Trigger Claude Code for quality check
        uses: actions/github-script@v7
        with:
          script: |
            const files = '${{ needs.export-marp.outputs.changed_files }}'.split(',');

            const fileList = files.map(f => '- `' + f + '`').join('\n');

            const comment = '@claude ä»¥ä¸‹ã®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š\n\n' +
              fileList + '\n\n' +
              'ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š\n' +
              '1. ãƒ†ãƒ¼ãƒã®é©åˆ‡ãªä½¿ç”¨ï¼ˆtitle/top/mainã‚¯ãƒ©ã‚¹ï¼‰\n' +
              '2. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ•´åˆæ€§\n' +
              '3. ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®æº–æ‹ \n' +
              '4. æ”¹å–„ææ¡ˆ\n\n' +
              '`/test_slide` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆçµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
  comment-result:
    needs: export-marp
    if: needs.export-marp.outputs.files_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download export summary
        uses: actions/download-artifact@v4
        with:
          name: export-summary

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let summary = '';
            try {
              summary = fs.readFileSync('export_summary.txt', 'utf8');
            } catch (error) {
              summary = 'ï¼ˆã‚µãƒãƒªãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼‰';
            }

            const files = '${{ needs.export-marp.outputs.changed_files }}'.split(',');
            const fileList = files.map(file => {
              const basename = file.replace('input/', '').replace('.md', '');
              return '- ğŸ“„ `' + file + '`\n  - ğŸ“• `output/' + basename + '.pdf`\n  - ğŸ“Š `output/' + basename + '.pptx`';
            }).join('\n');

            const runId = context.runId;
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const comment = '## ğŸ“Š Marpè³‡æ–™ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ\n\n' +
              '### ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«\n\n' +
              fileList + '\n\n' +
              '### ç”Ÿæˆçµæœ\n\n' +
              '```\n' + summary + '\n```\n\n' +
              '### ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\n\n' +
              'ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼š\n\n' +
              `- [ğŸ“ Artifacts ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${artifactUrl})\n` +
              '  - `marp-pdf-files` - PDFè³‡æ–™\n' +
              '  - `marp-pptx-files` - PPTXè³‡æ–™\n\n' +
              '**ä¿å­˜æœŸé–“**: 30æ—¥é–“\n\n' +
              '---\n\n' +
              'ğŸ’¡ **ãƒ’ãƒ³ãƒˆ**: ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ–ãƒ©ãƒ³ãƒã® `output/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚‚ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
